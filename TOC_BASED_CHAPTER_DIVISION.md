# 基于目录的章节划分 - 设计文档

## 核心思路

### 问题
- ❌ 之前：让 AI 分析整本书的内容来划分章节
- ❌ 问题：文档太长，AI 难以理解全部内容
- ❌ 结果：章节识别不准确，混乱

### 解决方案
- ✅ 现在：让 AI 只识别**目录**
- ✅ 优势：目录在前几页，格式清晰，结构明确
- ✅ 结果：快速、准确地获取章节结构

## 设计原理

### 为什么只需要目录？

1. **目录是作者的章节划分**
   - 作者已经精心设计了章节结构
   - 目录是最权威的章节划分依据
   - 不需要 AI 重新理解和划分

2. **目录格式清晰**
   - 有明确的章节编号
   - 有简洁的章节标题
   - 通常在前几页，容易定位

3. **AI 只需要知道章节名称**
   - 学习时，AI 知道"这是第3章"就够了
   - 不需要 AI 理解整本书的内容
   - 学生提问时，AI 根据章节上下文回答

## 实现策略

### 策略 1: 查找目录关键词

```python
# 查找包含"目录"、"Contents"等关键词的部分
toc_keywords = ['目录', '目　录', 'Contents', 'TABLE OF CONTENTS', '章节目录']

for keyword in toc_keywords:
    idx = document_text.find(keyword)
    if idx != -1:
        # 找到目录，提取其后的 5000 字符
        toc_section = document_text[idx:idx+5000]
        break
```

### 策略 2: 提取前 10 页

```python
# 如果没找到目录关键词，提取前 10000 字符
# 通常目录在前几页
toc_section = document_text[:10000]
```

### 策略 3: LLM 识别目录结构

```python
prompt = """
请从以下文本中提取教材的目录结构。

目录的特征：
1. 通常包含"目录"、"Contents"等标题
2. 有清晰的章节编号，如"第一章"、"Chapter 1"、"1."等
3. 章节标题后可能有页码
4. 格式整齐，有明显的层级结构

返回 JSON 格式：
{
    "has_toc": true/false,
    "total_chapters": 章节总数,
    "chapters": [
        {"chapter_number": 1, "chapter_title": "章节标题"},
        {"chapter_number": 2, "chapter_title": "章节标题"}
    ]
}
"""
```

### 策略 4: 启发式备用方案

```python
# 如果 LLM 也无法识别，使用正则表达式
patterns = [
    r'第([一二三四五六七八九十百]+)章[\s\u3000：:]*([^\n]{2,50}?)',
    r'第(\d+)章[\s\u3000：:]*([^\n]{2,50}?)',
    r'Chapter\s+(\d+)[\s：:]*([^\n]{2,50}?)',
    r'^(\d+)\.[\s\u3000]+([^\n]{5,50})',
    r'^([一二三四五六七八九十]+)、[\s\u3000]*([^\n]{5,50})',
]
```

## 工作流程

### 1. 文档上传
```
用户上传 PDF → 解析文本 → 存储到 ChromaDB
```

### 2. 目录提取
```
获取文档文本
    ↓
查找目录关键词
    ↓
提取目录部分（前 5000-10000 字符）
    ↓
LLM 识别目录结构
    ↓
提取章节列表
```

### 3. 章节创建
```
章节列表
    ↓
为每个章节创建 Progress 记录
    ↓
第一章解锁，其他章节锁定
```

### 4. 学习对话
```
学生选择章节
    ↓
AI 知道当前章节号和标题
    ↓
学生提问
    ↓
AI 基于章节上下文回答
```

## 示例

### 输入：教材文本（前 10000 字符）

```
线性代数与微积分教程

目录

第一章 线性代数基础 ........................... 1
  1.1 向量的定义 ............................... 2
  1.2 向量的运算 ............................... 5
  1.3 向量空间 ................................. 8

第二章 矩阵理论 ............................... 15
  2.1 矩阵的定义 ............................... 16
  2.2 矩阵运算 ................................. 20
  2.3 矩阵的秩 ................................. 25

第三章 微积分入门 ............................. 30
  3.1 极限 ..................................... 31
  3.2 导数 ..................................... 35
  3.3 积分 ..................................... 40
```

### 输出：章节结构

```json
{
  "has_toc": true,
  "total_chapters": 3,
  "chapters": [
    {
      "chapter_number": 1,
      "chapter_title": "线性代数基础"
    },
    {
      "chapter_number": 2,
      "chapter_title": "矩阵理论"
    },
    {
      "chapter_number": 3,
      "chapter_title": "微积分入门"
    }
  ]
}
```

## 优势

### 1. 准确性高
- ✅ 基于作者的章节划分
- ✅ 不会出现 AI 理解偏差
- ✅ 章节标题清晰准确

### 2. 速度快
- ✅ 只分析前几页
- ✅ 不需要处理整本书
- ✅ LLM 调用次数少

### 3. 可靠性强
- ✅ 目录格式相对固定
- ✅ 多种识别策略（LLM + 正则）
- ✅ 有备用方案

### 4. 资源消耗少
- ✅ 只需要前 10000 字符
- ✅ LLM token 消耗少
- ✅ 处理速度快

## 处理特殊情况

### 情况 1: 没有明确目录

```python
# 使用启发式方法在前 20000 字符中查找章节标记
# 如果还是找不到，根据文档长度创建默认章节
if doc_length < 5000:
    total_chapters = 1
elif doc_length < 20000:
    total_chapters = 3
else:
    total_chapters = 5
```

### 情况 2: 目录格式特殊

```python
# 支持多种目录格式
patterns = [
    '第一章',      # 中文章节
    'Chapter 1',   # 英文章节
    '1.',          # 数字编号
    '一、',        # 中文序号
]
```

### 情况 3: 扫描版 PDF

```python
# 如果是扫描版，OCR 可能有错误
# 使用更宽松的匹配规则
# 允许一定的格式偏差
```

## 与学习对话的集成

### AI 对话时的上下文

```python
# 学生选择"第3章 微积分入门"
context = {
    "document_id": 1,
    "document_title": "线性代数与微积分教程",
    "chapter_number": 3,
    "chapter_title": "微积分入门",
    "student_level": 3
}

# AI 回答时知道：
# 1. 这是哪本书
# 2. 这是第几章
# 3. 这章的标题是什么
# 4. 学生的水平如何

# AI 可以：
# 1. 根据章节标题调整回答内容
# 2. 引用相关章节内容
# 3. 推荐相关章节
```

### 示例对话

```
学生: 什么是导数？

AI 上下文:
- 文档: 线性代数与微积分教程
- 章节: 第3章 微积分入门
- 学生水平: L3 标准

AI 回答:
"在第3章《微积分入门》中，我们学习导数的概念。
导数表示函数的变化率，是微积分的核心概念之一。
让我用一个简单的例子来解释..."
```

## 代码结构

### 主要方法

```python
class ChapterDivider:
    async def extract_table_of_contents(self, document_text, document_title):
        """提取目录"""
        # 1. 查找目录关键词
        # 2. 提取目录部分
        # 3. LLM 识别
        # 4. 返回章节列表
        
    def _heuristic_division(self, document_text, document_title):
        """启发式备用方案"""
        # 1. 正则表达式匹配
        # 2. 创建默认章节
        # 3. 返回章节列表
        
    async def divide_document_into_chapters(self, document_id, user_id, document_text, db):
        """创建章节记录"""
        # 1. 提取目录
        # 2. 创建 Progress 记录
        # 3. 更新文档状态
```

## 测试用例

### 测试 1: 标准目录格式

```
输入: 包含"目录"关键词，格式规范
预期: 正确识别所有章节
```

### 测试 2: 英文目录

```
输入: "Contents" + "Chapter 1", "Chapter 2"
预期: 正确识别英文章节
```

### 测试 3: 无明确目录

```
输入: 没有"目录"关键词，但有章节标记
预期: 使用启发式方法识别
```

### 测试 4: 完全无结构

```
输入: 纯文本，无任何章节标记
预期: 创建默认章节（根据长度）
```

## 日志输出

```
📚 开始提取目录: 线性代数与微积分教程
✅ 找到目录关键词 '目录' 在位置 245
📝 LLM 返回内容: {"has_toc": true, "total_chapters": 3...
✅ 成功从目录提取 3 个章节
   1. 线性代数基础
   2. 矩阵理论
   3. 微积分入门
📖 开始分析文档: 线性代数与微积分教程
📄 文档长度: 45678 字符
✅ 识别到 3 个章节
  ✨ 创建章节 1: 线性代数基础
  ✨ 创建章节 2: 矩阵理论
  ✨ 创建章节 3: 微积分入门
```

## 总结

这个新的设计：
- ✅ **更聪明** - 只识别目录，不分析全文
- ✅ **更准确** - 基于作者的章节划分
- ✅ **更快速** - 只处理前几页
- ✅ **更可靠** - 多种识别策略
- ✅ **更实用** - AI 只需要知道章节名称

这是一个非常优雅的解决方案！🎉
